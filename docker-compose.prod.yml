# ./docker-compose.prod.yml (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
version: '3.8'

services:
  mongo:
    image: mongo:6
    restart: always
    volumes:
      - mongo_data:/data/db
    networks:
      - app-network
    # ‚úÖ –£–±—Ä–∞–ª–∏ env_file, –ø–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —è–≤–Ω–æ. –¢–∞–∫ —á–∏—â–µ.
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}

  backend:
    image: ${DOCKERHUB_USERNAME}/my-tg-app-backend:latest
    restart: always
    env_file: .env.prod
    depends_on:
      - mongo
    networks:
      - app-network

  nginx:
    image: ${DOCKERHUB_USERNAME}/my-tg-app-nginx:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - backend
    networks:
      - app-network
    # ‚ùå –£–ë–ò–†–ê–ï–ú –°–õ–û–ñ–ù–£–Æ –ö–û–ú–ê–ù–î–£. Nginx —Å–∞–º –∑–Ω–∞–µ—Ç, –∫–∞–∫ –µ–º—É –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è.
    # ‚úÖ –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: –°–∏–≥–Ω–∞–ª –¥–ª—è nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥.
    command: /bin/sh -c 'nginx -g "daemon off;"'

  certbot:
    image: certbot/certbot
    # ‚ùå –£–î–ê–õ–Ø–ï–ú entrypoint —Å —Ü–∏–∫–ª–æ–º.
    # ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ê–í–ò–õ–¨–ù–£–Æ –ö–û–ú–ê–ù–î–£ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.
    command: certonly --webroot --webroot-path=/var/www/certbot --email hitomi.jpeg@gmail.com -d ariyapoizon.ru --agree-tos --no-eff-email --force-renewal
    # üëÜ –ó–ê–ú–ï–ù–ò –¢–í–û–Ø@–ü–û–ß–¢–ê.COM –∏ —Ç–≤–æ–π-–¥–æ–º–µ–Ω.ru –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

volumes:
  mongo_data:

networks:
  app-network:
    driver: bridge